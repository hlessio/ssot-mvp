<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSOT-4000 Complete Demo - Knowledge Platform</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            color: #1a1a1a;
            height: 100vh;
            overflow: hidden;
        }

        /* Layout principale */
        .app-container {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            grid-template-rows: 60px 1fr 40px;
            height: 100vh;
            gap: 1px;
            background: #ddd;
        }

        /* Header */
        .app-header {
            grid-column: 1 / -1;
            background: #2c3e50;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .app-title {
            font-size: 20px;
            font-weight: 600;
            margin-right: auto;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #e74c3c;
            transition: background 0.3s;
        }

        .status-indicator.connected {
            background: #2ecc71;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(46, 204, 113, 0); }
            100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
        }

        /* Pannelli */
        .panel {
            background: white;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 16px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        /* Pannello Documenti */
        .document-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .document-card {
            padding: 12px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .document-card:hover {
            border-color: #3498db;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.1);
        }

        .document-card.active {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .document-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .document-meta {
            font-size: 12px;
            color: #666;
        }

        .document-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 8px;
        }

        .status-draft { background: #fff3cd; color: #856404; }
        .status-published { background: #d4edda; color: #155724; }
        .status-archived { background: #e2e3e5; color: #383d41; }

        /* Workspace */
        .workspace {
            background: #f5f7fa;
            position: relative;
            padding: 20px;
        }

        .workspace-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-auto-rows: 80px;
            gap: 16px;
            min-height: 600px;
            padding: 20px;
        }

        .workspace-module {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.06);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: all 0.3s;
            position: relative;
        }

        .workspace-module:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }

        .module-header {
            padding: 12px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: move;
        }

        .module-title {
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .module-icon {
            font-size: 16px;
        }

        .module-actions {
            display: flex;
            gap: 4px;
        }

        .module-action {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .module-action:hover {
            background: rgba(0,0,0,0.05);
        }

        .module-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }

        /* Module sizes */
        .module-small { grid-column: span 3; grid-row: span 3; }
        .module-medium { grid-column: span 4; grid-row: span 4; }
        .module-large { grid-column: span 6; grid-row: span 5; }
        .module-wide { grid-column: span 8; grid-row: span 3; }
        .module-tall { grid-column: span 4; grid-row: span 6; }

        /* Event Monitor */
        .event-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .event-item {
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #6c757d;
            font-size: 13px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .event-item.created { border-left-color: #28a745; }
        .event-item.updated { border-left-color: #ffc107; }
        .event-item.deleted { border-left-color: #dc3545; }
        .event-item.relation { border-left-color: #17a2b8; }

        .event-time {
            font-size: 11px;
            color: #6c757d;
            margin-bottom: 4px;
        }

        .event-details {
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 11px;
        }

        /* Metrics */
        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .metric-card {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            text-align: center;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
        }

        .metric-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 4px;
        }

        /* Footer */
        .app-footer {
            grid-column: 1 / -1;
            background: #2c3e50;
            color: rgba(255,255,255,0.7);
            display: flex;
            align-items: center;
            padding: 0 20px;
            font-size: 12px;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-success {
            background: #2ecc71;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-sm {
            padding: 4px 12px;
            font-size: 12px;
        }

        /* Module Library */
        .module-library {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .module-template {
            padding: 16px;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .module-template:hover {
            border-color: #3498db;
            background: #f0f8ff;
        }

        .module-template-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .module-template-name {
            font-weight: 600;
            font-size: 14px;
        }

        /* Empty states */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 48px;
            opacity: 0.3;
            margin-bottom: 16px;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tooltips */
        .tooltip {
            position: relative;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 4px 8px;
            background: rgba(0,0,0,0.8);
            color: white;
            font-size: 12px;
            border-radius: 4px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .tooltip:hover::after {
            opacity: 1;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .app-container {
                grid-template-columns: 250px 1fr 300px;
            }
        }

        @media (max-width: 900px) {
            .app-container {
                grid-template-columns: 1fr;
                grid-template-rows: 60px auto 1fr auto 40px;
            }
            
            .panel {
                border-right: none;
                border-bottom: 1px solid #ddd;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <h1 class="app-title">üöÄ SSOT-4000 Knowledge Platform - Complete Demo</h1>
            <div class="connection-status">
                <div class="status-indicator" id="wsIndicator"></div>
                <span id="wsStatus">Connecting...</span>
            </div>
        </header>

        <!-- Left Panel: Documents -->
        <aside class="panel" id="documentsPanel">
            <div class="panel-header">
                <span>üìÑ Documents</span>
                <button class="btn btn-primary btn-sm" onclick="openCreateDocumentModal()">+ New</button>
            </div>
            <div class="panel-content">
                <div id="documentList" class="document-list">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Center: Workspace -->
        <main class="panel workspace" id="workspace">
            <div id="workspaceContent">
                <div class="empty-state">
                    <div class="empty-state-icon">üìÑ</div>
                    <p>Select a document to view its workspace</p>
                </div>
            </div>
        </main>

        <!-- Right Panel: Real-time Monitor -->
        <aside class="panel" id="monitorPanel">
            <div class="panel-header">
                <span>üì° Real-time Monitor</span>
                <button class="btn btn-secondary btn-sm" onclick="clearEvents()">Clear</button>
            </div>
            <div class="panel-content">
                <!-- Metrics -->
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="messageCount">0</div>
                        <div class="metric-label">Messages</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="latencyValue">0ms</div>
                        <div class="metric-label">Avg Latency</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="moduleCount">0</div>
                        <div class="metric-label">Active Modules</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="updateCount">0</div>
                        <div class="metric-label">Updates</div>
                    </div>
                </div>

                <!-- Event List -->
                <h3 style="margin-bottom: 12px; font-size: 14px;">Recent Events</h3>
                <div id="eventList" class="event-list">
                    <!-- Events will be added here -->
                </div>
            </div>
        </aside>

        <!-- Footer -->
        <footer class="app-footer">
            <span>SSOT-4000 Phase 2 Complete ‚Ä¢ WebSocket: <span id="wsLatency">-</span>ms ‚Ä¢ </span>
            <span style="margin-left: auto;">
                <button class="btn btn-sm" onclick="runDemoScenario()">üé≠ Run Demo Scenario</button>
                <button class="btn btn-sm" onclick="createSimpleDemo()">üß™ Simple Demo</button>
                <button class="btn btn-sm" onclick="openMultiWindow()">ü™ü Open Second Window</button>
            </span>
        </footer>
    </div>

    <!-- Create Document Modal -->
    <div class="modal" id="createDocumentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New Document</h2>
                <button class="btn btn-sm" onclick="closeModal('createDocumentModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Document Name</label>
                    <input type="text" class="form-control" id="docName" placeholder="e.g., Callsheet Day 1">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="docDescription" rows="3" placeholder="Document description..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-control" id="docStatus">
                        <option value="draft">Draft</option>
                        <option value="published">Published</option>
                        <option value="archived">Archived</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Project ID (optional)</label>
                    <input type="text" class="form-control" id="docProjectId" placeholder="project-123">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createDocumentModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createDocument()">Create Document</button>
            </div>
        </div>
    </div>

    <!-- Add Module Modal -->
    <div class="modal" id="addModuleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Module to Workspace</h2>
                <button class="btn btn-sm" onclick="closeModal('addModuleModal')">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="module-library">
                    <div class="module-template" onclick="selectModuleTemplate('contact-list')">
                        <div class="module-template-icon">üë•</div>
                        <div class="module-template-name">Contact List</div>
                    </div>
                    <div class="module-template" onclick="selectModuleTemplate('notes-board')">
                        <div class="module-template-icon">üìù</div>
                        <div class="module-template-name">Notes Board</div>
                    </div>
                    <div class="module-template" onclick="selectModuleTemplate('task-tracker')">
                        <div class="module-template-icon">‚úÖ</div>
                        <div class="module-template-name">Task Tracker</div>
                    </div>
                    <div class="module-template" onclick="selectModuleTemplate('timeline')">
                        <div class="module-template-icon">üìÖ</div>
                        <div class="module-template-name">Timeline</div>
                    </div>
                    <div class="module-template" onclick="selectModuleTemplate('data-table')">
                        <div class="module-template-icon">üìä</div>
                        <div class="module-template-name">Data Table</div>
                    </div>
                    <div class="module-template" onclick="selectModuleTemplate('analytics')">
                        <div class="module-template-icon">üìà</div>
                        <div class="module-template-name">Analytics</div>
                    </div>
                </div>
                
                <div id="moduleConfig" style="margin-top: 20px; display: none;">
                    <hr style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label class="form-label">Module Name</label>
                        <input type="text" class="form-control" id="moduleName" placeholder="e.g., Cast List">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Target Entity Type</label>
                        <input type="text" class="form-control" id="moduleEntityType" placeholder="e.g., Contact">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Size</label>
                        <select class="form-control" id="moduleSize">
                            <option value="small">Small (3x3)</option>
                            <option value="medium" selected>Medium (4x4)</option>
                            <option value="large">Large (6x5)</option>
                            <option value="wide">Wide (8x3)</option>
                            <option value="tall">Tall (4x6)</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addModuleModal')">Cancel</button>
                <button class="btn btn-primary" onclick="addModuleToDocument()" id="addModuleBtn" disabled>Add Module</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        const state = {
            wsConnection: null,
            currentDocument: null,
            documents: new Map(),
            modules: new Map(),
            metrics: {
                messageCount: 0,
                updateCount: 0,
                latencies: [],
                startTime: Date.now()
            },
            selectedModuleTemplate: null
        };

        // Initialize WebSocket connection
        function initWebSocket() {
            const ws = new WebSocket('ws://localhost:3000');
            
            ws.onopen = () => {
                console.log('‚úÖ WebSocket connected');
                updateConnectionStatus(true);
                
                // Subscribe to all CompositeDocument events
                ws.send(JSON.stringify({
                    type: 'subscribe',
                    pattern: {
                        entityType: 'CompositeDocument'
                    }
                }));
                
                // Subscribe to module relations
                ws.send(JSON.stringify({
                    type: 'subscribe',
                    pattern: {
                        relationType: 'CONTAINS_MODULE'
                    }
                }));
                
                // Start latency monitoring
                startLatencyMonitoring(ws);
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onerror = (error) => {
                console.error('‚ùå WebSocket error:', error);
                updateConnectionStatus(false);
            };
            
            ws.onclose = () => {
                console.log('üîå WebSocket disconnected');
                updateConnectionStatus(false);
                // Reconnect after 3 seconds
                setTimeout(initWebSocket, 3000);
            };
            
            state.wsConnection = ws;
        }

        // Handle incoming WebSocket messages
        function handleWebSocketMessage(data) {
            state.metrics.messageCount++;
            updateMetric('messageCount', state.metrics.messageCount);
            
            // Add to event log
            addEventToLog(data);
            
            // Handle different message types
            if (data.type === 'change' || 
                (data.type === 'attributeChange' && data.data?.entityType === 'CompositeDocument')) {
                
                if (data.changeType === 'created' || data.type === 'document-created') {
                    // Refresh document list
                    loadDocuments();
                } else if (data.changeType === 'updated' || data.type === 'document-updated') {
                    state.metrics.updateCount++;
                    updateMetric('updateCount', state.metrics.updateCount);
                    // Refresh current document if it's the one being updated
                    if (state.currentDocument && 
                        (data.entityId === state.currentDocument.id || 
                         data.data?.documentId === state.currentDocument.id)) {
                        loadDocument(state.currentDocument.id);
                    }
                } else if (data.changeType === 'deleted') {
                    // Refresh document list and clear workspace if deleted
                    loadDocuments();
                    if (state.currentDocument && data.entityId === state.currentDocument.id) {
                        clearWorkspace();
                    }
                }
            } else if (data.type === 'relation-change' && data.relationType === 'CONTAINS_MODULE') {
                // Module added/removed/updated
                if (state.currentDocument && 
                    (data.sourceEntityId === state.currentDocument.id || 
                     state.currentDocument.id === data.data?.documentId)) {
                    loadDocument(state.currentDocument.id);
                }
            }
        }

        // Connection status management
        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('wsIndicator');
            const status = document.getElementById('wsStatus');
            
            if (connected) {
                indicator.classList.add('connected');
                status.textContent = 'Connected';
            } else {
                indicator.classList.remove('connected');
                status.textContent = 'Disconnected';
            }
        }

        // Latency monitoring
        function startLatencyMonitoring(ws) {
            setInterval(() => {
                if (ws.readyState === WebSocket.OPEN) {
                    const pingTime = Date.now();
                    ws.send(JSON.stringify({
                        type: 'ping',
                        timestamp: pingTime
                    }));
                }
            }, 5000);
        }

        // Document management
        async function loadDocuments() {
            try {
                const response = await fetch('/api/documents');
                const result = await response.json();
                
                if (result.success) {
                    displayDocuments(result.data);
                }
            } catch (error) {
                console.error('Error loading documents:', error);
            }
        }

        function displayDocuments(documentsArray) {
            const container = document.getElementById('documentList');
            
            if (!documentsArray || documentsArray.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÑ</div>
                        <p>No documents yet</p>
                        <button class="btn btn-primary" onclick="openCreateDocumentModal()">Create First Document</button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = documentsArray.map(doc => `
                <div class="document-card ${state.currentDocument?.id === doc.id ? 'active' : ''}" 
                     onclick="selectDocument('${doc.id}')"
                     data-doc-id="${doc.id}">
                    <div class="document-title">${doc.name}</div>
                    <div class="document-meta">
                        ${doc.moduleCount || 0} modules
                        <span class="document-status status-${doc.status}">${doc.status}</span>
                    </div>
                </div>
            `).join('');
            
            // Update documents map
            state.documents.clear();
            documentsArray.forEach(doc => state.documents.set(doc.id, doc));
        }

        async function selectDocument(documentId) {
            // Update UI
            document.querySelectorAll('.document-card').forEach(card => {
                card.classList.toggle('active', card.dataset.docId === documentId);
            });
            
            // Load document details
            await loadDocument(documentId);
        }

        async function loadDocument(documentId) {
            try {
                const response = await fetch(`/api/documents/${documentId}`);
                const result = await response.json();
                
                
                if (result.success) {
                    const documentData = result.data;
                    
                    // Parse JSON fields if they are strings
                    if (typeof documentData.layout === 'string') {
                        try {
                            documentData.layout = JSON.parse(documentData.layout);
                        } catch (e) {
                            console.error('Error parsing layout:', e);
                            documentData.layout = {};
                        }
                    }
                    
                    if (typeof documentData.metadata === 'string') {
                        try {
                            documentData.metadata = JSON.parse(documentData.metadata);
                        } catch (e) {
                            documentData.metadata = {};
                        }
                    }
                    
                    state.currentDocument = documentData;
                    displayWorkspace(documentData);
                } else {
                    console.error('Error in response:', result);
                }
            } catch (error) {
                console.error('Error loading document:', error);
            }
        }

        function displayWorkspace(documentData) {
            const workspaceElement = document.getElementById('workspaceContent');
            
            if (!documentData.modules || documentData.modules.length === 0) {
                workspaceElement.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üß©</div>
                        <p>No modules in this workspace</p>
                        <button class="btn btn-primary" onclick="openAddModuleModal()">Add First Module</button>
                    </div>
                `;
                return;
            }
            
            // Create workspace grid
            workspaceElement.innerHTML = `
                <div class="workspace-grid" id="workspaceGrid">
                    ${documentData.modules.map(module => createModuleElement(module)).join('')}
                </div>
                <button class="btn btn-primary" 
                        style="position: absolute; bottom: 20px; right: 20px;"
                        onclick="openAddModuleModal()">
                    + Add Module
                </button>
            `;
            
            // Update module count
            updateMetric('moduleCount', documentData.modules.length);
        }

        function createModuleElement(module) {
            const sizeClass = getModuleSizeClass(module.size);
            const icon = getModuleIcon(module.templateModuleId || module.templateId || 'default');
            
            // Ensure position and size have valid values
            const position = module.position || { x: 1, y: 1 };
            const size = module.size || { width: 4, height: 4 };
            
            return `
                <div class="workspace-module ${sizeClass}" 
                     data-module-id="${module.moduleId}"
                     style="grid-column: ${position.x} / span ${size.width};
                            grid-row: ${position.y} / span ${size.height};">
                    <div class="module-header">
                        <div class="module-title">
                            <span class="module-icon">${icon}</span>
                            ${module.instanceName || module.name || 'Unnamed Module'}
                        </div>
                        <div class="module-actions">
                            <button class="module-action tooltip" data-tooltip="Move" onclick="moveModule('${module.moduleId}')">‚ú•</button>
                            <button class="module-action tooltip" data-tooltip="Resize" onclick="resizeModule('${module.moduleId}')">‚§°</button>
                            <button class="module-action tooltip" data-tooltip="Remove" onclick="removeModule('${module.moduleId}')">‚úï</button>
                        </div>
                    </div>
                    <div class="module-content">
                        ${renderModuleContent(module)}
                    </div>
                </div>
            `;
        }

        function getModuleSizeClass(size) {
            if (!size) return 'module-medium';
            
            const width = size.width || 4;
            const height = size.height || 4;
            
            if (width <= 3 && height <= 3) return 'module-small';
            if (width >= 8) return 'module-wide';
            if (height >= 6) return 'module-tall';
            if (width >= 6 || height >= 5) return 'module-large';
            return 'module-medium';
        }

        function getModuleIcon(templateId) {
            const icons = {
                'contact-list': 'üë•',
                'notes-board': 'üìù',
                'task-tracker': '‚úÖ',
                'timeline': 'üìÖ',
                'data-table': 'üìä',
                'analytics': 'üìà',
                'default': 'üß©'
            };
            return icons[templateId] || icons.default;
        }

        function renderModuleContent(module) {
            // Simplified content rendering based on module type
            const templateId = module.templateModuleId || module.templateId;
            
            switch (templateId) {
                case 'contact-list':
                    return `
                        <div style="font-size: 14px;">
                            <p>üë§ John Doe - Actor</p>
                            <p>üë§ Jane Smith - Director</p>
                            <p>üë§ Mike Johnson - Producer</p>
                            <p style="color: #666; font-size: 12px;">+ ${Math.floor(Math.random() * 10) + 3} more...</p>
                        </div>
                    `;
                case 'notes-board':
                    return `
                        <div style="font-size: 14px;">
                            <p>üìå Remember to check lighting setup</p>
                            <p>üìå Catering arrives at 11:30 AM</p>
                            <p>üìå Weather forecast: Partly cloudy</p>
                        </div>
                    `;
                case 'task-tracker':
                    return `
                        <div style="font-size: 14px;">
                            <p>‚úÖ Scene 1: Setup complete</p>
                            <p>‚è≥ Scene 2: In progress</p>
                            <p>‚≠ï Scene 3: Pending</p>
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                                <small style="color: #666;">Progress: 33%</small>
                            </div>
                        </div>
                    `;
                case 'timeline':
                    return `
                        <div style="font-size: 14px;">
                            <p>üïê 08:00 - Call time</p>
                            <p>üïê 09:00 - Makeup & wardrobe</p>
                            <p>üïê 10:30 - First shot</p>
                            <p>üïê 13:00 - Lunch break</p>
                        </div>
                    `;
                default:
                    return `
                        <div style="text-align: center; color: #666; padding: 20px;">
                            <p>${module.targetEntityType || 'Data'}</p>
                            <p style="font-size: 24px; font-weight: bold; margin: 10px 0;">
                                ${Math.floor(Math.random() * 100) + 20}
                            </p>
                            <p style="font-size: 12px;">Items</p>
                        </div>
                    `;
            }
        }

        // Create document
        async function createDocument() {
            const name = document.getElementById('docName').value;
            const description = document.getElementById('docDescription').value;
            const status = document.getElementById('docStatus').value;
            const projectId = document.getElementById('docProjectId').value;
            
            if (!name) {
                alert('Please enter a document name');
                return;
            }
            
            try {
                const response = await fetch('/api/documents', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name,
                        description,
                        status,
                        projectId: projectId || null,
                        ownerId: 'demo-user-' + Date.now(),
                        metadata: {
                            createdFrom: 'complete-demo',
                            demoMode: true
                        }
                    })
                });
                
                if (response.ok) {
                    closeModal('createDocumentModal');
                    // Clear form
                    document.getElementById('docName').value = '';
                    document.getElementById('docDescription').value = '';
                    document.getElementById('docProjectId').value = '';
                    
                    // Reload documents
                    loadDocuments();
                } else {
                    const error = await response.text();
                    alert('Error creating document: ' + error);
                }
            } catch (error) {
                alert('Error creating document: ' + error.message);
            }
        }

        // Module management
        function selectModuleTemplate(templateId) {
            state.selectedModuleTemplate = templateId;
            
            // Show configuration section
            document.getElementById('moduleConfig').style.display = 'block';
            document.getElementById('addModuleBtn').disabled = false;
            
            // Pre-fill module name based on template
            const names = {
                'contact-list': 'Contact List',
                'notes-board': 'Production Notes',
                'task-tracker': 'Task Tracker',
                'timeline': 'Daily Timeline',
                'data-table': 'Data Table',
                'analytics': 'Analytics Dashboard'
            };
            document.getElementById('moduleName').value = names[templateId] || 'New Module';
            
            // Set appropriate entity type
            const entityTypes = {
                'contact-list': 'Contact',
                'task-tracker': 'Task',
                'default': 'Entity'
            };
            document.getElementById('moduleEntityType').value = entityTypes[templateId] || entityTypes.default;
        }

        async function addModuleToDocument() {
            if (!state.currentDocument) {
                alert('Please select a document first');
                return;
            }
            
            const moduleName = document.getElementById('moduleName').value;
            const entityType = document.getElementById('moduleEntityType').value;
            const size = document.getElementById('moduleSize').value;
            
            if (!moduleName || !entityType) {
                alert('Please fill in all fields');
                return;
            }
            
            // First create a ModuleInstance
            try {
                const moduleResponse = await fetch('/api/module-instances', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        instanceName: moduleName,
                        templateModuleId: state.selectedModuleTemplate,
                        targetEntityType: entityType,
                        targetEntityId: 'demo-entity-' + Date.now(),
                        description: `Module created from complete demo for ${entityType}`
                    })
                });
                
                if (!moduleResponse.ok) {
                    throw new Error('Failed to create module instance');
                }
                
                const moduleResult = await moduleResponse.json();
                const moduleId = moduleResult.id || moduleResult.data?.id;
                
                // Now add it to the document
                const sizeMap = {
                    'small': { width: 3, height: 3 },
                    'medium': { width: 4, height: 4 },
                    'large': { width: 6, height: 5 },
                    'wide': { width: 8, height: 3 },
                    'tall': { width: 4, height: 6 }
                };
                
                const response = await fetch(`/api/documents/${state.currentDocument.id}/modules`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'add',
                        moduleId: moduleId,
                        layoutConfig: {
                            position: { 
                                x: 1 + Math.floor(Math.random() * 6), 
                                y: 1 + Math.floor(Math.random() * 3) 
                            },
                            size: sizeMap[size] || sizeMap.medium,
                            config: {
                                theme: 'default',
                                createdFrom: 'demo'
                            }
                        }
                    })
                });
                
                if (response.ok) {
                    closeModal('addModuleModal');
                    // Reload document to show new module
                    loadDocument(state.currentDocument.id);
                } else {
                    alert('Error adding module to document');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function removeModule(moduleId) {
            if (!confirm('Remove this module from the workspace?')) return;
            
            try {
                const response = await fetch(`/api/documents/${state.currentDocument.id}/modules`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'remove',
                        moduleId: moduleId
                    })
                });
                
                if (response.ok) {
                    loadDocument(state.currentDocument.id);
                }
            } catch (error) {
                alert('Error removing module: ' + error.message);
            }
        }

        function moveModule(moduleId) {
            // Simple implementation: prompt for new position
            const x = prompt('Enter new X position (1-12):', '1');
            const y = prompt('Enter new Y position (1-10):', '1');
            
            if (x && y) {
                updateModuleLayout(moduleId, { position: { x: parseInt(x), y: parseInt(y) } });
            }
        }

        function resizeModule(moduleId) {
            const sizes = ['small', 'medium', 'large', 'wide', 'tall'];
            const currentSize = prompt('Enter size (small/medium/large/wide/tall):', 'medium');
            
            if (sizes.includes(currentSize)) {
                const sizeMap = {
                    'small': { width: 3, height: 3 },
                    'medium': { width: 4, height: 4 },
                    'large': { width: 6, height: 5 },
                    'wide': { width: 8, height: 3 },
                    'tall': { width: 4, height: 6 }
                };
                updateModuleLayout(moduleId, { size: sizeMap[currentSize] });
            }
        }

        async function updateModuleLayout(moduleId, layoutConfig) {
            try {
                const response = await fetch(`/api/documents/${state.currentDocument.id}/modules`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'update',
                        moduleId: moduleId,
                        layoutConfig: layoutConfig
                    })
                });
                
                if (response.ok) {
                    loadDocument(state.currentDocument.id);
                }
            } catch (error) {
                alert('Error updating module: ' + error.message);
            }
        }

        // Event monitoring
        function addEventToLog(data) {
            const eventList = document.getElementById('eventList');
            
            const eventItem = document.createElement('div');
            eventItem.className = `event-item ${data.changeType || data.type}`;
            
            const time = new Date().toLocaleTimeString();
            let details = '';
            
            if (data.type === 'change' || data.type === 'attributeChange') {
                details = `${data.entityType || data.data?.entityType} ${data.changeType || 'changed'}`;
            } else if (data.type === 'relation-change') {
                details = `Relation ${data.relationType} ${data.changeType}`;
            } else {
                details = data.type;
            }
            
            eventItem.innerHTML = `
                <div class="event-time">${time}</div>
                <div class="event-details">${details}</div>
            `;
            
            eventList.insertBefore(eventItem, eventList.firstChild);
            
            // Keep only last 50 events
            while (eventList.children.length > 50) {
                eventList.removeChild(eventList.lastChild);
            }
        }

        function clearEvents() {
            document.getElementById('eventList').innerHTML = '';
            state.metrics.messageCount = 0;
            state.metrics.updateCount = 0;
            updateMetric('messageCount', 0);
            updateMetric('updateCount', 0);
        }

        // Utility functions
        function updateMetric(metricId, value) {
            const element = document.getElementById(metricId);
            if (element) {
                element.textContent = value;
            }
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function openCreateDocumentModal() {
            openModal('createDocumentModal');
        }

        function openAddModuleModal() {
            if (!state.currentDocument) {
                alert('Please select a document first');
                return;
            }
            openModal('addModuleModal');
        }

        function clearWorkspace() {
            state.currentDocument = null;
            document.getElementById('workspaceContent').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üìÑ</div>
                    <p>Select a document to view its workspace</p>
                </div>
            `;
        }

        // Demo scenarios
        async function runDemoScenario() {
            if (!confirm('This will create demo data and perform automated actions. Continue?')) return;
            
            try {
                // Create a demo project document (without projectId since we don't have a project entity)
                const docResponse = await fetch('/api/documents', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: 'Demo Film Production - Day 1',
                        description: 'Automated demo showing all SSOT-4000 features',
                        status: 'published',
                        ownerId: 'demo-user',
                        metadata: {
                            demoMode: true,
                            location: 'Studio A',
                            date: new Date().toISOString().split('T')[0]
                        }
                    })
                });
                
                if (!docResponse.ok) throw new Error('Failed to create demo document');
                
                const docResult = await docResponse.json();
                const documentId = docResult.data.id;
                
                // Select the created document
                await selectDocument(documentId);
                
                // Add various modules with delays for visual effect
                const modules = [
                    { template: 'contact-list', name: 'Cast Members', entity: 'Contact', size: 'medium' },
                    { template: 'notes-board', name: 'Production Notes', entity: 'Note', size: 'medium' },
                    { template: 'timeline', name: 'Shooting Schedule', entity: 'Event', size: 'wide' },
                    { template: 'task-tracker', name: 'Scene Checklist', entity: 'Task', size: 'tall' }
                ];
                
                for (let i = 0; i < modules.length; i++) {
                    const mod = modules[i];
                    
                    // Create module instance
                    const modResponse = await fetch('/api/module-instances', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            instanceName: mod.name,
                            templateModuleId: mod.template,
                            targetEntityType: mod.entity,
                            targetEntityId: `demo-${mod.entity.toLowerCase()}-${Date.now()}`,
                            description: `Demo ${mod.name}`
                        })
                    });
                    
                    if (!modResponse.ok) continue;
                    
                    const modResult = await modResponse.json();
                    const moduleId = modResult.id || modResult.data?.id;
                    
                    // Add to document
                    const sizeMap = {
                        'small': { width: 3, height: 3 },
                        'medium': { width: 4, height: 4 },
                        'large': { width: 6, height: 5 },
                        'wide': { width: 8, height: 3 },
                        'tall': { width: 4, height: 6 }
                    };
                    
                    await fetch(`/api/documents/${documentId}/modules`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'add',
                            moduleId: moduleId,
                            layoutConfig: {
                                position: { 
                                    x: 1 + (i % 3) * 4, 
                                    y: 1 + Math.floor(i / 3) * 4 
                                },
                                size: sizeMap[mod.size] || sizeMap.medium,
                                config: { demoModule: true }
                            }
                        })
                    });
                    
                    // Wait a bit for visual effect
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                alert('Demo scenario completed! Document created with 4 modules. Try opening a second window to see real-time sync.');
                
            } catch (error) {
                alert('Error running demo: ' + error.message);
            }
        }

        // Simple demo - just creates a document without modules
        async function createSimpleDemo() {
            try {
                const response = await fetch('/api/documents', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: 'Simple Test Document',
                        description: 'A simple document for testing',
                        status: 'draft',
                        ownerId: 'test-user-' + Date.now()
                    })
                });
                
                if (response.ok) {
                    alert('Simple document created successfully!');
                    loadDocuments();
                } else {
                    const error = await response.text();
                    alert('Error: ' + error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function openMultiWindow() {
            const newWindow = window.open(window.location.href, '_blank', 
                'width=1200,height=800,left=100,top=100');
            
            if (newWindow) {
                // Use BroadcastChannel for cross-window communication
                const channel = new BroadcastChannel('ssot-4000-demo');
                
                setTimeout(() => {
                    channel.postMessage({
                        type: 'sync-request',
                        currentDocumentId: state.currentDocument?.id
                    });
                }, 1000);
            }
        }

        // Initialize BroadcastChannel for multi-window sync
        function initBroadcastChannel() {
            const channel = new BroadcastChannel('ssot-4000-demo');
            
            channel.onmessage = (event) => {
                if (event.data.type === 'sync-request' && event.data.currentDocumentId) {
                    // If this window has a document selected, share it
                    if (state.currentDocument) {
                        channel.postMessage({
                            type: 'sync-response',
                            documentId: state.currentDocument.id
                        });
                    }
                } else if (event.data.type === 'sync-response' && event.data.documentId) {
                    // Load the same document in the new window
                    selectDocument(event.data.documentId);
                }
            };
        }

        // Initialize the application
        function init() {
            console.log('üöÄ Initializing SSOT-4000 Complete Demo');
            
            // Initialize WebSocket
            initWebSocket();
            
            // Initialize BroadcastChannel
            initBroadcastChannel();
            
            // Load initial documents
            loadDocuments();
            
            // Setup event listeners
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    // Close any open modals
                    document.querySelectorAll('.modal.active').forEach(modal => {
                        modal.classList.remove('active');
                    });
                }
            });
            
            // Update time-based metrics
            setInterval(() => {
                if (state.metrics.latencies.length > 0) {
                    const avgLatency = state.metrics.latencies.reduce((a, b) => a + b, 0) / state.metrics.latencies.length;
                    updateMetric('latencyValue', Math.round(avgLatency) + 'ms');
                    
                    // Keep only last 10 latencies
                    if (state.metrics.latencies.length > 10) {
                        state.metrics.latencies = state.metrics.latencies.slice(-10);
                    }
                }
            }, 1000);
        }

        // Start the application when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>