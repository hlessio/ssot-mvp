<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test CompositeDocument WebSocket</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        input, select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            flex: 1;
        }
        .events {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background: #f9f9f9;
        }
        .event {
            padding: 5px;
            margin-bottom: 5px;
            border-left: 3px solid #007bff;
            background: white;
            font-size: 14px;
        }
        .event.created {
            border-left-color: #28a745;
        }
        .event.updated {
            border-left-color: #ffc107;
        }
        .event.deleted {
            border-left-color: #dc3545;
        }
        .document-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        .document-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: white;
        }
        .document-card h3 {
            margin-top: 0;
            color: #007bff;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            background: #e9ecef;
        }
        .status-badge.draft {
            background: #ffc107;
            color: #000;
        }
        .status-badge.published {
            background: #28a745;
            color: white;
        }
        .module-count {
            float: right;
            color: #666;
            font-size: 14px;
        }
        .error {
            color: #dc3545;
            padding: 10px;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
        }
        .success {
            color: #155724;
            padding: 10px;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test CompositeDocument - Fase 1 SSOT-4000</h1>
        
        <!-- WebSocket Status -->
        <div class="section">
            <h2>WebSocket Status</h2>
            <div id="wsStatus">Disconnesso</div>
        </div>

        <!-- Create Document -->
        <div class="section">
            <h2>Crea Nuovo Documento</h2>
            <div class="controls">
                <input type="text" id="docName" placeholder="Nome documento" value="Test Document">
                <input type="text" id="docDescription" placeholder="Descrizione" value="Documento di test per Fase 1">
                <input type="text" id="ownerId" placeholder="Owner ID" value="user-123">
                <select id="docStatus">
                    <option value="draft">Draft</option>
                    <option value="published">Published</option>
                    <option value="archived">Archived</option>
                </select>
                <button onclick="createDocument()">Crea Documento</button>
            </div>
            <div id="createResult"></div>
        </div>

        <!-- List Documents -->
        <div class="section">
            <h2>Documenti Esistenti</h2>
            <button onclick="listDocuments()">Aggiorna Lista</button>
            <div id="documentList" class="document-list"></div>
        </div>

        <!-- WebSocket Events -->
        <div class="section">
            <h2>Eventi WebSocket in Real-time</h2>
            <button onclick="clearEvents()">Pulisci Eventi</button>
            <div id="events" class="events"></div>
        </div>
    </div>

    <script>
        let ws = null;
        let currentDocumentId = null;

        // Assicurati che il DOM sia caricato
        function domReady(fn) {
            if (document.readyState === 'complete' || document.readyState === 'interactive') {
                setTimeout(fn, 1);
            } else {
                document.addEventListener('DOMContentLoaded', fn);
            }
        }

        // Inizializza WebSocket
        function initWebSocket() {
            ws = new WebSocket('ws://localhost:3000');
            
            ws.onopen = () => {
                console.log('Connected to WebSocket');
                const statusEl = document.getElementById('wsStatus');
                if (statusEl) {
                    statusEl.innerHTML = '<span class="success">‚úÖ Connesso</span>';
                }
                
                // Sottoscrivi agli eventi CompositeDocument
                ws.send(JSON.stringify({
                    type: 'subscribe',
                    pattern: {
                        entityType: 'CompositeDocument'
                    }
                }));
                
                // Sottoscrivi anche agli eventi delle relazioni CONTAINS_MODULE
                ws.send(JSON.stringify({
                    type: 'subscribe',
                    pattern: {
                        relationType: 'CONTAINS_MODULE'
                    }
                }));
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('WebSocket message:', data);
                
                if (data.type === 'change') {
                    displayEvent(data);
                    // Aggiorna automaticamente la lista documenti
                    listDocuments();
                }
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                const statusEl = document.getElementById('wsStatus');
                if (statusEl) {
                    statusEl.innerHTML = '<span class="error">‚ùå Errore</span>';
                }
            };
            
            ws.onclose = () => {
                const statusEl = document.getElementById('wsStatus');
                if (statusEl) {
                    statusEl.innerHTML = '<span class="error">‚ùå Disconnesso</span>';
                }
                // Riconnetti dopo 3 secondi
                setTimeout(initWebSocket, 3000);
            };
        }

        // Visualizza evento WebSocket
        function displayEvent(data) {
            const eventsDiv = document.getElementById('events');
            if (!eventsDiv) return;
            
            const eventDiv = document.createElement('div');
            eventDiv.className = `event ${data.changeType}`;
            
            const timestamp = new Date().toLocaleTimeString();
            let content = `<strong>${timestamp}</strong> - `;
            
            if (data.entityType === 'CompositeDocument') {
                content += `Documento ${data.changeType}: ${data.entityId}`;
                if (data.data?.name) {
                    content += ` (${data.data.name})`;
                }
            } else if (data.relationType === 'CONTAINS_MODULE') {
                content += `Modulo ${data.changeType}: ${data.sourceEntityId} ‚Üí ${data.targetEntityId}`;
            }
            
            eventDiv.innerHTML = content;
            eventsDiv.insertBefore(eventDiv, eventsDiv.firstChild);
            
            // Mantieni solo gli ultimi 50 eventi
            while (eventsDiv.children.length > 50) {
                eventsDiv.removeChild(eventsDiv.lastChild);
            }
        }

        // Crea nuovo documento
        async function createDocument() {
            const name = document.getElementById('docName')?.value;
            const description = document.getElementById('docDescription')?.value;
            const ownerId = document.getElementById('ownerId')?.value;
            const status = document.getElementById('docStatus')?.value;
            
            if (!name || !ownerId) {
                const resultEl = document.getElementById('createResult');
                if (resultEl) {
                    resultEl.innerHTML = '<div class="error">‚ùå Nome e Owner ID sono obbligatori</div>';
                }
                return;
            }
            
            try {
                const response = await fetch('/api/documents', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name,
                        description,
                        ownerId,
                        status,
                        metadata: {
                            createdVia: 'test-page',
                            timestamp: new Date().toISOString()
                        }
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const document = result.success ? result.data : result;
                    currentDocumentId = document.id;
                    
                    const resultEl = document.getElementById('createResult');
                    if (resultEl) {
                        resultEl.innerHTML = 
                            `<div class="success">‚úÖ Documento creato: ${document.id}</div>`;
                    }
                    
                    // Pulisci il form
                    const nameEl = document.getElementById('docName');
                    const descEl = document.getElementById('docDescription');
                    if (nameEl) nameEl.value = '';
                    if (descEl) descEl.value = '';
                    
                    // Aggiorna la lista
                    listDocuments();
                } else {
                    const error = await response.text();
                    const resultEl = document.getElementById('createResult');
                    if (resultEl) {
                        resultEl.innerHTML = 
                            `<div class="error">‚ùå Errore: ${error}</div>`;
                    }
                }
            } catch (error) {
                const resultEl = document.getElementById('createResult');
                if (resultEl) {
                    resultEl.innerHTML = 
                        `<div class="error">‚ùå Errore: ${error.message}</div>`;
                }
            }
        }

        // Lista documenti
        async function listDocuments() {
            try {
                const response = await fetch('/api/documents');
                const result = await response.json();
                
                // L'API restituisce {success: true, data: [...]}
                const documents = result.success ? result.data : [];
                
                const listDiv = document.getElementById('documentList');
                if (!listDiv) return;
                
                listDiv.innerHTML = '';
                
                if (!documents || documents.length === 0) {
                    listDiv.innerHTML = '<p>Nessun documento trovato</p>';
                    return;
                }
                
                documents.forEach(doc => {
                    const card = document.createElement('div');
                    card.className = 'document-card';
                    card.innerHTML = `
                        <h3>${doc.name}</h3>
                        <p>${doc.description || 'Nessuna descrizione'}</p>
                        <p><small>ID: ${doc.id}</small></p>
                        <p>Owner: ${doc.ownerId}</p>
                        <span class="status-badge ${doc.status}">${doc.status}</span>
                        <span class="module-count">${doc.moduleCount || 0} moduli</span>
                        <div style="margin-top: 10px;">
                            <button onclick="getDocument('${doc.id}')">Dettagli</button>
                            <button onclick="deleteDocument('${doc.id}')">Elimina</button>
                            <button onclick="addTestModule('${doc.id}')">Aggiungi Modulo Test</button>
                        </div>
                    `;
                    listDiv.appendChild(card);
                });
            } catch (error) {
                const listDiv = document.getElementById('documentList');
                if (listDiv) {
                    listDiv.innerHTML = 
                        `<div class="error">‚ùå Errore caricamento documenti: ${error.message}</div>`;
                }
            }
        }

        // Ottieni dettagli documento
        async function getDocument(documentId) {
            try {
                const response = await fetch(`/api/documents/${documentId}`);
                const result = await response.json();
                
                console.log('Document details:', result);
                alert(JSON.stringify(result, null, 2));
            } catch (error) {
                alert(`Errore: ${error.message}`);
            }
        }

        // Elimina documento
        async function deleteDocument(documentId) {
            if (!confirm('Sicuro di voler eliminare questo documento?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/documents/${documentId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    listDocuments();
                } else {
                    alert('Errore eliminazione documento');
                }
            } catch (error) {
                alert(`Errore: ${error.message}`);
            }
        }

        // Aggiungi modulo di test
        async function addTestModule(documentId) {
            // Per ora usiamo un ID modulo fittizio
            const moduleId = 'test-module-' + Date.now();
            
            try {
                const response = await fetch(`/api/documents/${documentId}/modules`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'add',
                        moduleId: moduleId,
                        layoutConfig: {
                            position: { x: Math.random() * 10, y: Math.random() * 10 },
                            size: { width: 4, height: 3 },
                            config: { test: true }
                        }
                    })
                });
                
                if (response.ok) {
                    alert('Modulo aggiunto con successo!');
                    listDocuments();
                } else {
                    const error = await response.text();
                    alert(`Errore: ${error}`);
                }
            } catch (error) {
                alert(`Errore: ${error.message}`);
            }
        }

        // Pulisci eventi
        function clearEvents() {
            const eventsDiv = document.getElementById('events');
            if (eventsDiv) {
                eventsDiv.innerHTML = '';
            }
        }

        // Inizializza quando il DOM √® pronto
        domReady(() => {
            console.log('DOM ready, initializing...');
            initWebSocket();
            listDocuments();
        });
    </script>
</body>
</html>